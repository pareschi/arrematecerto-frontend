<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Arremate Certo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #0f172a;
    }

    /* Mapa ocupa o fundo inteiro */
    #map {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    /* Top bar */
    #topbar {
      position: fixed;
      z-index: 10;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(90deg, #020617, #0f172a);
      color: #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    #title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #title-row h1 {
      font-size: 18px;
      margin: 0;
    }

    #title-row span {
      font-size: 11px;
      opacity: 0.8;
    }

    #controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #controls-row label {
      font-size: 12px;
      opacity: 0.9;
    }

    #fileInput {
      font-size: 12px;
      max-width: 260px;
    }

    #status {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Bottom sheet */
    #sheet {
      position: fixed;
      z-index: 10;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px 14px;
      background: rgba(248,250,252,0.97);
      backdrop-filter: blur(8px);
      border-radius: 14px 14px 0 0;
      box-shadow: 0 -4px 18px rgba(15,23,42,0.4);
    }

    #sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #cbd5f5;
      margin: 0 auto 6px;
    }

    #sheet h2 {
      margin: 0 0 4px;
      font-size: 15px;
      color: #0f172a;
    }

    #sheet p {
      margin: 2px 0;
      font-size: 12px;
      color: #334155;
    }

    #sheet .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag.green { background: #dcfce7; color: #166534; }
    .tag.orange { background: #fef3c7; color: #92400e; }

    @media (min-width: 900px) {
      #sheet {
        left: auto;
        right: 16px;
        bottom: 16px;
        width: 360px;
        border-radius: 16px;
      }
      #sheet-handle { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <header id="topbar">
    <div id="title-row">
      <div>
        <h1>Arremate Certo</h1>
        <span>Envie o CSV da Caixa e visualize os imóveis no mapa, com análise de IA.</span>
      </div>
    </div>

    <div id="controls-row">
      <label for="fileInput">CSV da Caixa (.csv)</label>
      <input type="file" id="fileInput" accept=".csv" />
      <span id="status"></span>
    </div>
  </header>

  <section id="sheet">
    <div id="sheet-handle"></div>
    <h2>Importe um CSV da Caixa</h2>
    <p>No site da Caixa, escolha o estado, baixe a lista de imóveis em CSV e selecione o arquivo aqui.</p>
    <p style="margin-top:6px;">Depois clique em um pin no mapa para ver os detalhes e rodar a análise de viabilidade com IA.</p>
  </section>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- PapaParse para ler CSV no navegador -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Backend (para IA)
    const BACKEND_URL = 'https://arrematecerto.onrender.com';

    const fileInput = document.getElementById('fileInput');
    const statusEl  = document.getElementById('status');
    const sheetEl   = document.getElementById('sheet');

    // Mapa base
    const map = L.map('map').setView([-14.235, -51.9253], 4); // Brasil
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let imoveis = [];
    let imovelSelecionado = null;
    let analiseAtual = null;

    // Coordenadas aproximadas por cidade/UF
    const cityCoords = {
      'sao paulo|SP': [-23.55, -46.63],
      'santos|SP': [-23.9632, -46.3322],
      'guarujá|SP': [-23.9925, -46.2569],
      'guaruja|SP': [-23.9925, -46.2569],
      'campinas|SP': [-22.9099, -47.0626],
      'rio de janeiro|RJ': [-22.9068, -43.1729],
      'belo horizonte|MG': [-19.9167, -43.9345],
      'curitiba|PR': [-25.4284, -49.2733],
      'porto alegre|RS': [-30.0346, -51.2177],
      'salvador|BA': [-12.9777, -38.5016],
      'fortaleza|CE': [-3.7319, -38.5267],
      'recife|PE': [-8.0476, -34.877],
      'manaus|AM': [-3.119, -60.0217],
      'goiania|GO': [-16.6864, -49.2643],
      'brasilia|DF': [-15.8267, -47.9218]
    };

    function guessCoords(uf, cidade) {
      const key = `${(cidade || '').toLowerCase().trim()}|${(uf || '').toUpperCase().trim()}`;
      if (cityCoords[key]) return cityCoords[key];
      return [-14.235, -51.9253];
    }

    function parseNumeroBr(valorStr) {
      if (!valorStr) return 0;
      let s = String(valorStr).trim();
      s = s.replace(/[R$\s]/g, '');
      s = s.replace(/\./g, '').replace(',', '.');
      const n = Number(s);
      return Number.isNaN(n) ? 0 : n;
    }

    // row é um objeto com as colunas do CSV da Caixa
    function normalizarImovel(row, idx) {
      const uf        = (row['UF'] || '').trim();
      const cidade    = (row['Cidade'] || '').trim();
      const bairro    = (row['Bairro'] || '').trim();
      const endereco  = (row['Endereço'] || '').trim();
      const modalidade= (row['Modalidade de venda'] || '').trim();
      const tipo      = (row['Descrição'] || '').split(',')[0] || 'Imóvel';

      const valor     = parseNumeroBr(row['Preço']);
      const valorAval = parseNumeroBr(row['Valor de avaliação']);
      const desconto  = row['Desconto'] || '';
      const link      = (row['Link de acesso'] || '').trim();

      const [lat, lng] = guessCoords(uf, cidade);

      return {
        id: idx,
        bruto: row,
        uf,
        cidade,
        bairro,
        logradouro: endereco,
        modalidade,
        tipo,
        situacao: '',               // CSV não tem situação explícita
        valor,
        valor_avaliacao: valorAval,
        desconto,
        link,
        area: 0,                    // CSV não traz área em coluna separada
        lat,
        lng
      };
    }

    function preencherSheetInicial() {
      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>Importe um CSV da Caixa</h2>
        <p>No site da Caixa, selecione o estado, baixe o CSV e depois escolha o arquivo aqui em cima.</p>
        <p style="margin-top:6px;">Os imóveis serão plotados no mapa. Toque em um pin para ver os detalhes e rodar uma análise de viabilidade com IA.</p>
      `;
    }

    function preencherSheetImovel(i) {
      imovelSelecionado = i;
      analiseAtual = null;

      const modalidade = i.modalidade || 'Modalidade não informada';
      const situacao   = i.situacao   || 'Situação não informada';

      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>${i.tipo || 'Imóvel de leilão'}</h2>
        <div class="tag-row">
          <span class="tag green">${modalidade}</span>
          <span class="tag orange">${situacao}</span>
        </div>
        <p><strong>Localização:</strong> ${i.logradouro || ''}${i.logradouro ? ', ' : ''}${i.bairro || ''} – ${i.cidade || ''}/${i.uf || ''}</p>
        <p><strong>Valor de venda:</strong> ${i.valor ? 'R$ ' + i.valor.toLocaleString('pt-BR') : 'Não informado'}</p>
        <p><strong>Valor de avaliação:</strong> ${i.valor_avaliacao ? 'R$ ' + i.valor_avaliacao.toLocaleString('pt-BR') : 'Não informado'}</p>
        <p><strong>Desconto informado:</strong> ${i.desconto || 'Não informado'}%</p>
        ${
          i.link
            ? `<p><a href="${i.link}" target="_blank" rel="noopener" style="font-size:12px;">Ver anúncio no site da Caixa</a></p>`
            : ''
        }

        <button id="btnAnaliseIA" style="
          margin-top:8px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid #0f766e;
          background:#14b8a6;
          color:#022c22;
          font-size:12px;
          font-weight:600;
          cursor:pointer;
        ">
          Analisar viabilidade com IA
        </button>

        <div id="analiseIA" style="margin-top:8px; font-size:12px;"></div>
      `;

      const btnAnalise = document.getElementById('btnAnaliseIA');
      const analiseDiv = document.getElementById('analiseIA');

      btnAnalise.addEventListener('click', async () => {
        if (!imovelSelecionado) return;

        analiseDiv.textContent = 'Analisando viabilidade...';

        try {
          const resp = await fetch(`${BACKEND_URL}/api/imoveis/analise`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(imovelSelecionado)
          });

          if (!resp.ok) {
            analiseDiv.textContent = `Erro na análise (HTTP ${resp.status})`;
            return;
          }

          const data = await resp.json();
          analiseAtual = data;

          analiseDiv.innerHTML = `
            <p><strong>Score de viabilidade:</strong> ${data.score ?? '?'} / 100</p>
            <p><strong>Resumo:</strong> ${data.resumo || ''}</p>
            ${
              Array.isArray(data.pontos_positivos)
                ? '<p><strong>Pontos positivos:</strong></p><ul>' +
                  data.pontos_positivos.map(p => `<li>${p}</li>`).join('') +
                  '</ul>'
                : ''
            }
            ${
              Array.isArray(data.pontos_atencao)
                ? '<p><strong>Pontos de atenção:</strong></p><ul>' +
                  data.pontos_atencao.map(p => `<li>${p}</li>`).join('') +
                  '</ul>'
                : ''
            }
            <p><strong>Estratégia sugerida:</strong> ${data.estrategia || ''}</p>
          `;
        } catch (e) {
          console.error(e);
          analiseDiv.textContent = 'Erro ao gerar análise de IA.';
        }
      });
    }

    function plotarImoveisNoMapa() {
      markersLayer.clearLayers();

      if (!imoveis.length) {
        preencherSheetInicial();
        statusEl.textContent = 'Nenhum imóvel carregado.';
        return;
      }

      const bounds = [];

      imoveis.forEach(i => {
        const lat = i.lat ?? -14.235;
        const lng = i.lng ?? -51.9253;

        const marker = L.marker([lat, lng]).addTo(markersLayer);
        bounds.push([lat, lng]);

        const popupHtml = `
          <b>${i.tipo || 'Imóvel'}</b><br/>
          ${i.cidade || ''}/${i.uf || ''}
        `;
        marker.bindPopup(popupHtml);

        marker.on('click', () => {
          preencherSheetImovel(i);
        });
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [40, 80] });
      }

      preencherSheetInicial();
    }

    // Lê o CSV da Caixa: arquivo -> linhas -> encontra cabeçalho "N° do imóvel" -> monta objetos
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusEl.textContent = 'Lendo CSV...';

      Papa.parse(file, {
        header: false,
        skipEmptyLines: true,
        delimiter: ';',
        complete: function(results) {
          try {
            const rows = results.data;

            // encontra a linha do cabeçalho real ("N° do imóvel;UF;Cidade;...")
            const headerIndex = rows.findIndex(
              r => (r[0] || '').trim().startsWith('N° do imóvel')
            );

            if (headerIndex === -1) {
              statusEl.textContent = 'Não encontrei o cabeçalho esperado no CSV.';
              preencherSheetInicial();
              return;
            }

            const headerRow = rows[headerIndex].map(h => (h || '').trim());
            const dataRows = rows.slice(headerIndex + 1).filter(
              r => (r[0] || '').trim() !== ''
            );

            let lista = dataRows.map((r, idx) => {
              const obj = {};
              headerRow.forEach((h, colIdx) => {
                obj[h] = (r[colIdx] || '').trim();
              });
              return normalizarImovel(obj, idx);
            });

            const total = lista.length;
            const LIMITE = 400;
            if (lista.length > LIMITE) {
              lista = lista.slice(0, LIMITE);
              statusEl.textContent = `CSV carregado (${total} imóveis). Mostrando primeiros ${LIMITE} no mapa.`;
            } else {
              statusEl.textContent = `CSV carregado (${total} imóveis).`;
            }

            imoveis = lista;
            plotarImoveisNoMapa();
          } catch (e) {
            console.error(e);
            statusEl.textContent = 'Erro ao processar o CSV.';
            preencherSheetInicial();
          }
        },
        error: function(err) {
          console.error(err);
          statusEl.textContent = 'Erro ao ler o arquivo CSV.';
          preencherSheetInicial();
        }
      });
    });

    // estado inicial
    preencherSheetInicial();
  </script>
</body>
</html>
