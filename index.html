<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Arremate Certo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #0f172a;
    }

    #map {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    #topbar {
      position: fixed;
      z-index: 10;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(90deg, #020617, #0f172a);
      color: #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    #title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #title-row h1 {
      font-size: 18px;
      margin: 0;
    }

    #title-row span {
      font-size: 11px;
      opacity: 0.8;
    }

    #controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #controls-row label {
      font-size: 12px;
      opacity: 0.9;
    }

    #fileInput {
      font-size: 12px;
      max-width: 260px;
    }

    #status {
      font-size: 11px;
      opacity: 0.9;
    }

    #sheet {
      position: fixed;
      z-index: 10;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px 14px;
      background: rgba(248,250,252,0.97);
      backdrop-filter: blur(8px);
      border-radius: 14px 14px 0 0;
      box-shadow: 0 -4px 18px rgba(15,23,42,0.4);
    }

    #sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #cbd5f5;
      margin: 0 auto 6px;
    }

    #sheet h2 {
      margin: 0 0 4px;
      font-size: 15px;
      color: #0f172a;
    }

    #sheet p {
      margin: 2px 0;
      font-size: 12px;
      color: #334155;
    }

    #sheet .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag.green { background: #dcfce7; color: #166534; }
    .tag.orange { background: #fef3c7; color: #92400e; }

    @media (min-width: 900px) {
      #sheet {
        left: auto;
        right: 16px;
        bottom: 16px;
        width: 360px;
        border-radius: 16px;
      }
      #sheet-handle { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <header id="topbar">
    <div id="title-row">
      <div>
        <h1>Arremate Certo</h1>
        <span>Envie o CSV da Caixa e visualize os imóveis no mapa, com análise de IA.</span>
      </div>
    </div>

    <div id="controls-row">
      <label for="fileInput">CSV da Caixa (.csv)</label>
      <input type="file" id="fileInput" accept=".csv" />
      <span id="status"></span>
    </div>
  </header>

  <section id="sheet">
    <div id="sheet-handle"></div>
    <h2>Importe um CSV da Caixa</h2>
    <p>No site da Caixa, baixe o CSV do estado desejado e selecione o arquivo aqui em cima.</p>
    <p style="margin-top:6px;">Depois clique em um pin para ver detalhes e rodar a análise de viabilidade com IA.</p>
  </section>

  <!-- Leaflet + PapaParse -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const BACKEND_URL = "https://arrematecerto.onrender.com";

    const fileInput = document.getElementById("fileInput");
    const statusEl  = document.getElementById("status");
    const sheetEl   = document.getElementById("sheet");

    const map = L.map("map").setView([-22.5, -48], 6); // centro SP
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let imoveis = [];
    let imovelSelecionado = null;

    function hashCode(str) {
      str = String(str || "");
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    const UF_BOXES = {
      "SP": { latMin: -25.5, latMax: -20.0, lngMin: -53.0, lngMax: -44.0 }
    };
    const BR_BOX = { latMin: -33.0, latMax: 5.0, lngMin: -74.0, lngMax: -35.0 };

    function randomCoords(uf, cidade, bairro) {
      const box = UF_BOXES[(uf || "").toUpperCase()] || BR_BOX;
      const h = hashCode(`${cidade}|${bairro}|${uf}`);
      const latFrac = (h % 1000) / 1000;
      const lngFrac = ((Math.floor(h / 1000)) % 1000) / 1000;
      const lat = box.latMin + latFrac * (box.latMax - box.latMin);
      const lng = box.lngMin + lngFrac * (box.lngMax - box.lngMin);
      return [lat, lng];
    }

    function parseNumeroBr(valorStr) {
      if (!valorStr) return 0;
      let s = String(valorStr).trim();
      s = s.replace(/[R$\s]/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return Number.isNaN(n) ? 0 : n;
    }

    function normalizarImovel(row, idx) {
      const uf         = (row["UF"] || "").trim();
      const cidade     = (row["Cidade"] || "").trim();
      const bairro     = (row["Bairro"] || "").trim();
      const endereco   = (row["Endereço"] || "").trim();
      const modalidade = (row["Modalidade de venda"] || "").trim();
      const tipo       = ((row["Descrição"] || "").split(",")[0] || "Imóvel").trim();

      const valor      = parseNumeroBr(row["Preço"]);
      const valorAval  = parseNumeroBr(row["Valor de avaliação"]);
      const desconto   = (row["Desconto"] || "").trim();
      const link       = (row["Link de acesso"] || "").trim();

      const [lat, lng] = randomCoords(uf, cidade, bairro);

      return {
        id: idx,
        bruto: row,
        uf,
        cidade,
        bairro,
        logradouro: endereco,
        modalidade,
        tipo,
        valor,
        valor_avaliacao: valorAval,
        desconto,
        link,
        area: 0,
        lat,
        lng
      };
    }

    function preencherSheetInicial() {
      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>Importe um CSV da Caixa</h2>
        <p>Depois clique em um pin para ver detalhes e usar IA.</p>
      `;
    }

    async function geocodeEndereco(imovel) {
      const enderecoFmt = `${imovel.logradouro}, ${imovel.bairro}, ${imovel.cidade}, ${imovel.uf}, Brasil`;

      if (!window._geoCache) window._geoCache = {};
      if (window._geoCache[enderecoFmt]) {
        return window._geoCache[enderecoFmt];
      }

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(enderecoFmt)}&email=arrematecerto@app`;

      try {
        const resp = await fetch(url, {
          headers: {
            "User-Agent": "ArremateCerto/1.0 (pesquisa de imoveis)"
          }
        });
        const data = await resp.json();
        if (Array.isArray(data) && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
            window._geoCache[enderecoFmt] = [lat, lon];
            return [lat, lon];
          }
        }
      } catch (e) {
        console.error("Erro ao geocodificar:", e);
      }
      return [imovel.lat, imovel.lng]; // fallback
    }

    function preencherSheetImovel(i) {
      imovelSelecionado = i;

      const valorTexto =
        i.valor && i.valor > 0
          ? "R$ " + i.valor.toLocaleString("pt-BR")
          : "Não informado";

      const avalTexto =
        i.valor_avaliacao && i.valor_avaliacao > 0
          ? "R$ " + i.valor_avaliacao.toLocaleString("pt-BR")
          : "Não informado";

      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>${i.tipo}</h2>
        <div class="tag-row">
          <span class="tag green">${i.modalidade || "Modalidade não informada"}</span>
        </div>

        <p><strong>Local:</strong> ${i.logradouro || ""}${i.logradouro ? ", " : ""}${i.bairro || ""} – ${i.cidade || ""}/${i.uf || ""}</p>
        <p><strong>Valor:</strong> ${valorTexto}</p>
        <p><strong>Avaliação:</strong> ${avalTexto}</p>
        <p><strong>Desconto informado:</strong> ${i.desconto || "Não informado"}</p>
        ${
          i.link
            ? `<p><a href="${i.link}" target="_blank" rel="noopener" style="font-size:12px;">Ver anúncio no site da Caixa</a></p>`
            : ""
        }

        <button id="btnGeo" style="
          margin-top:6px;
          padding:6px 10px;
          border-radius:999px;
          background:#6366f1;
          color:#fff;
          border:none;
          cursor:pointer;
          font-size:12px;
        ">Posicionar no mapa</button>

        <button id="btnIA" style="
          margin-top:6px;
          margin-left:4px;
          padding:6px 10px;
          border-radius:999px;
          background:#14b8a6;
          color:#022c22;
          border:none;
          cursor:pointer;
          font-size:12px;
        ">Analisar com IA</button>

        <div id="respIA" style="margin-top:6px; font-size:12px;"></div>
      `;

      const btnGeo = document.getElementById("btnGeo");
      const btnIA  = document.getElementById("btnIA");
      const respIA = document.getElementById("respIA");

      btnGeo.onclick = async () => {
        btnGeo.disabled = true;
        btnGeo.textContent = "Localizando...";
        const [lat, lon] = await geocodeEndereco(i);
        i.lat = lat;
        i.lng = lon;
        map.setView([lat, lon], 16);
        btnGeo.textContent = "Posicionado";
      };

      btnIA.onclick = async () => {
        respIA.textContent = "Analisando viabilidade...";
        try {
          const resp = await fetch(`${BACKEND_URL}/api/imoveis/analise`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(i)
          });
          if (!resp.ok) {
            respIA.textContent = `Erro na análise (HTTP ${resp.status})`;
            return;
          }
          const data = await resp.json();
          respIA.innerHTML = `
            <p><strong>Score:</strong> ${data.score ?? "?"}/100</p>
            <p><strong>Resumo:</strong> ${data.resumo || ""}</p>
          `;
        } catch (e) {
          console.error(e);
          respIA.textContent = "Erro ao chamar IA.";
        }
      };
    }

    function plotarImoveisNoMapa() {
      markersLayer.clearLayers();

      if (!imoveis.length) {
        preencherSheetInicial();
        statusEl.textContent = "Nenhum imóvel carregado.";
        return;
      }

      const bounds = [];

      imoveis.forEach(i => {
        const marker = L.marker([i.lat, i.lng]).addTo(markersLayer);
        bounds.push([i.lat, i.lng]);

        marker.on("click", () => {
          preencherSheetImovel(i);
        });
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [40, 80] });
      } else {
        map.setView(bounds[0] || [-22.5, -48], 7);
      }

      preencherSheetInicial();
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusEl.textContent = "Lendo CSV...";

      Papa.parse(file, {
        header: false,
        skipEmptyLines: true,
        delimiter: ";",
        complete: function(results) {
          try {
            const rows = results.data;

            // >>> AJUSTE AQUI: acha o header pela combinação UF + Cidade na 2ª e 3ª colunas
            const headerIndex = rows.findIndex(r => {
              const c1 = (r[1] || "").trim().toUpperCase();
              const c2 = (r[2] || "").trim().toUpperCase();
              return c1 === "UF" && c2 === "CIDADE";
            });

            if (headerIndex === -1) {
              console.error("Cabeçalho não encontrado. Primeiras linhas:", rows.slice(0,5));
              statusEl.textContent = "Erro: cabeçalho do CSV não encontrado.";
              preencherSheetInicial();
              return;
            }

            const headerRow = rows[headerIndex].map(h => (h || "").trim());
            const dataRows = rows
              .slice(headerIndex + 1)
              .filter(r => (r[0] || "").trim() !== "");

            let lista = dataRows.map((r, idx) => {
              const obj = {};
              headerRow.forEach((h, colIdx) => {
                obj[h] = (r[colIdx] || "").trim();
              });
              return normalizarImovel(obj, idx);
            });

            const total = lista.length;
            const LIMITE = 400;
            if (lista.length > LIMITE) {
              lista = lista.slice(0, LIMITE);
              statusEl.textContent = `CSV carregado (${total} imóveis). Mostrando primeiros ${LIMITE} no mapa.`;
            } else {
              statusEl.textContent = `CSV carregado (${total} imóveis).`;
            }

            imoveis = lista;
            plotarImoveisNoMapa();
          } catch (e) {
            console.error("Erro no processamento do CSV:", e);
            statusEl.textContent = "Erro ao processar o CSV (veja o console do navegador).";
            preencherSheetInicial();
          }
        },
        error: function(err) {
          console.error("Erro PapaParse:", err);
          statusEl.textContent = "Erro ao ler o arquivo CSV.";
          preencherSheetInicial();
        }
      });
    });

    preencherSheetInicial();
  </script>
</body>
</html>
