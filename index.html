<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Arremate Certo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #0f172a;
    }

    /* Mapa ocupa o fundo inteiro */
    #map {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    /* Top bar */
    #topbar {
      position: fixed;
      z-index: 10;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(90deg, #020617, #0f172a);
      color: #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    #title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #title-row h1 {
      font-size: 18px;
      margin: 0;
    }

    #title-row span {
      font-size: 11px;
      opacity: 0.8;
    }

    #controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #controls-row label {
      font-size: 12px;
      opacity: 0.9;
    }

    #fileInput {
      font-size: 12px;
      max-width: 260px;
    }

    #status {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Bottom sheet */
    #sheet {
      position: fixed;
      z-index: 10;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px 14px;
      background: rgba(248,250,252,0.97);
      backdrop-filter: blur(8px);
      border-radius: 14px 14px 0 0;
      box-shadow: 0 -4px 18px rgba(15,23,42,0.4);
    }

    #sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #cbd5f5;
      margin: 0 auto 6px;
    }

    #sheet h2 {
      margin: 0 0 4px;
      font-size: 15px;
      color: #0f172a;
    }

    #sheet p {
      margin: 2px 0;
      font-size: 12px;
      color: #334155;
    }

    #sheet .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag.green { background: #dcfce7; color: #166534; }
    .tag.orange { background: #fef3c7; color: #92400e; }

    @media (min-width: 900px) {
      #sheet {
        left: auto;
        right: 16px;
        bottom: 16px;
        width: 360px;
        border-radius: 16px;
      }
      #sheet-handle { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <header id="topbar">
    <div id="title-row">
      <div>
        <h1>Arremate Certo</h1>
        <span>Envie o CSV da Caixa e visualize os imóveis no mapa, com análise de IA.</span>
      </div>
    </div>

    <div id="controls-row">
      <label for="fileInput">CSV da Caixa (.csv)</label>
      <input type="file" id="fileInput" accept=".csv" />
      <span id="status"></span>
    </div>
  </header>

  <section id="sheet">
    <div id="sheet-handle"></div>
    <h2>Importe um CSV da Caixa</h2>
    <p>No site da Caixa, escolha o estado, baixe a lista de imóveis em CSV e selecione o arquivo aqui.</p>
    <p style="margin-top:6px;">Depois clique em um pin no mapa para ver os detalhes e rodar a análise de viabilidade com IA.</p>
  </section>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- PapaParse para ler CSV no navegador -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Backend fixo (somente para IA)
    const BACKEND_URL = 'https://arrematecerto.onrender.com';

    const fileInput = document.getElementById('fileInput');
    const statusEl  = document.getElementById('status');
    const sheetEl   = document.getElementById('sheet');

    // Mapa
    const map = L.map('map').setView([-14.235, -51.9253], 4); // Brasil
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let imoveis = [];
    let imovelSelecionado = null;
    let analiseAtual = null;

    // Coordenadas aproximadas por cidade/UF para não ficar tudo no centro
    const cityCoords = {
      'sao paulo|SP': [-23.55, -46.63],
      'santos|SP': [-23.9632, -46.3322],
      'guarujá|SP': [-23.9925, -46.2569],
      'guaruja|SP': [-23.9925, -46.2569],
      'rio de janeiro|RJ': [-22.9068, -43.1729],
      'belo horizonte|MG': [-19.9167, -43.9345],
      'curitiba|PR': [-25.4284, -49.2733],
      'porto alegre|RS': [-30.0346, -51.2177],
      'salvador|BA': [-12.9777, -38.5016],
      'fortaleza|CE': [-3.7319, -38.5267],
      'recife|PE': [-8.0476, -34.8770],
      'manaus|AM': [-3.1190, -60.0217],
      'goiania|GO': [-16.6864, -49.2643],
      'brasilia|DF': [-15.8267, -47.9218]
    };

    function guessCoords(uf, cidade) {
      const key = `${(cidade || '').toLowerCase().trim()}|${(uf || '').toUpperCase().trim()}`;
      if (cityCoords[key]) return cityCoords[key];
      // fallback: centro aproximado do Brasil
      return [-14.235, -51.9253];
    }

    function parseNumeroBr(valorStr) {
      if (!valorStr) return 0;
      let s = String(valorStr).trim();
      s = s.replace(/[R$\s]/g, '');
      s = s.replace(/\./g, '').replace(',', '.');
      const n = Number(s);
      return Number.isNaN(n) ? 0 : n;
    }

    function normalizarImovel(row, idx) {
      const uf =
        row['UF'] ||
        row['Uf'] ||
        row['uf'] ||
        '';

      const cidade =
        row['MUNICIPIO'] ||
        row['Município'] ||
        row['MUNICÍPIO'] ||
        row['CIDADE'] ||
        row['Cidade'] ||
        '';

      const bairro =
        row['BAIRRO'] ||
        row['Bairro'] ||
        '';

      const logradouro =
        row['ENDERECO'] ||
        row['Endereço'] ||
        row['LOGRADOURO'] ||
        row['Logradouro'] ||
        '';

      const modalidade =
        row['MODALIDADE'] ||
        row['Modalidade'] ||
        '';

      const tipo =
        row['TIPO_IMOVEL'] ||
        row['Tipo de Imóvel'] ||
        row['TIPO'] ||
        '';

      const situacao =
        row['SITUACAO'] ||
        row['Situação'] ||
        '';

      const valorStr =
        row['VALOR'] ||
        row['Valor'] ||
        row['VALOR_AVALIACAO'] ||
        row['Valor de Avaliação'] ||
        '';

      const areaStr =
        row['AREA_TOTAL'] ||
        row
