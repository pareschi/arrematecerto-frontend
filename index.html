<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Arremate Certo – v0.3</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;   /* mapa ocupa TUDO */
      width: 100vw;
    }
    /* Painel flutuante (UF + botão) */
    #controls {
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      max-width: 420px;
      margin: 0 auto;
      padding: 10px 12px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
    }
    #controls h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }
    #controls p {
      margin: 0 0 8px;
      font-size: 12px;
    }
    #controls select, #controls button {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #controls button {
      background: #2563eb;
      border-color: #2563eb;
      color: #fff;
      margin-left: 6px;
      cursor: pointer;
    }
    #controls button:active {
      transform: scale(0.98);
    }
    #status {
      margin-top: 6px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <h2>Arremate Certo – v0.3</h2>
    <p>Toque em “Buscar imóveis” para ver os pins no mapa.</p>
    <div>
      <label for="ufSelect">UF:</label>
      <select id="ufSelect">
        <option value="SP">SP</option>
        <option value="RJ">RJ</option>
        <option value="MG">MG</option>
        <option value="PR">PR</option>
        <option value="RS">RS</option>
      </select>
      <button id="btnBuscar">Buscar imóveis</button>
    </div>
    <div id="status"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // Backend FIXO do Arremate Certo
    const BACKEND_URL = 'https://arrematecerto.onrender.com';

    const ufSelect = document.getElementById('ufSelect');
    const btnBuscar = document.getElementById('btnBuscar');
    const statusEl = document.getElementById('status');

    // cria o mapa centrado em SP
    const map = L.map('map').setView([-23.55, -46.63], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    async function buscarImoveis() {
      const uf = ufSelect.value;
      statusEl.textContent = 'Carregando imóveis...';

      try {
        const resp = await fetch(`${BACKEND_URL}/api/imoveis?uf=${encodeURIComponent(uf)}`);
        if (!resp.ok) {
          throw new Error('HTTP ' + resp.status);
        }
        const imoveis = await resp.json();
        statusEl.textContent = `Encontrados: ${imoveis.length} imóveis`;

        markersLayer.clearLayers();
        if (!imoveis.length) return;

        const bounds = [];

        imoveis.forEach(i => {
          const lat = i.lat ?? -23.55;
          const lng = i.lng ?? -46.63;

          const marker = L.marker([lat, lng]).addTo(markersLayer);
          bounds.push([lat, lng]);

          const popupHtml = `
            <b>${i.tipo || 'Imóvel'}</b><br/>
            ${i.logradouro || ''}<br/>
            ${i.bairro || ''} - ${i.cidade || ''}/${i.uf || ''}<br/>
            Modalidade: ${i.modalidade || ''}<br/>
            Valor: R$ ${i.valor?.toLocaleString('pt-BR') || ''}<br/>
            Área: ${i.area || ''} m²
          `;
          marker.bindPopup(popupHtml);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Erro ao carregar imóveis';
      }
    }

    btnBuscar.addEventListener('click', buscarImoveis);
  </script>
</body>
</html>
