<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Arremate Certo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #0f172a;
    }

    #map {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    #topbar {
      position: fixed;
      z-index: 10;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px 14px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(90deg, #020617, #0f172a);
      color: #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    #title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #title-row h1 {
      font-size: 18px;
      margin: 0;
    }

    #title-row span {
      font-size: 11px;
      opacity: 0.8;
    }

    #upload-row, #filters-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #upload-row label {
      font-size: 12px;
      opacity: 0.9;
    }

    #fileInput {
      font-size: 12px;
      max-width: 260px;
    }

    #status {
      font-size: 11px;
      opacity: 0.9;
    }

    select, input[type="number"] {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }

    select:disabled, input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #filters-row {
      margin-top: 2px;
    }

    #filters-row label {
      font-size: 11px;
      opacity: 0.9;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .valor-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .valor-group span {
      font-size: 11px;
      white-space: nowrap;
      opacity: 0.9;
    }

    .valor-group input {
      width: 80px;
    }

    #btnFiltrar {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    #btnFiltrar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #sheet {
      position: fixed;
      z-index: 10;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 14px 14px;
      background: rgba(248,250,252,0.97);
      backdrop-filter: blur(8px);
      border-radius: 14px 14px 0 0;
      box-shadow: 0 -4px 18px rgba(15,23,42,0.4);
    }

    #sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #cbd5f5;
      margin: 0 auto 6px;
    }

    #sheet h2 {
      margin: 0 0 4px;
      font-size: 15px;
      color: #0f172a;
    }

    #sheet p {
      margin: 2px 0;
      font-size: 12px;
      color: #334155;
    }

    #sheet .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag.green { background: #dcfce7; color: #166534; }
    .tag.orange { background: #fef3c7; color: #92400e; }

    @media (min-width: 900px) {
      #sheet {
        left: auto;
        right: 16px;
        bottom: 16px;
        width: 360px;
        border-radius: 16px;
      }
      #sheet-handle { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <header id="topbar">
    <div id="title-row">
      <div>
        <h1>Arremate Certo</h1>
        <span>Imóveis de leilão da Caixa no mapa, com filtros e análise de IA.</span>
      </div>
    </div>

    <div id="upload-row">
      <label for="fileInput">CSV da Caixa (.csv)</label>
      <input type="file" id="fileInput" accept=".csv" />
      <span id="status"></span>
    </div>

    <div id="filters-row">
      <div class="filter-group">
        <label for="cidadeFilter">Cidade</label>
        <select id="cidadeFilter" disabled>
          <option value="">Todas</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="modalidadeFilter">Modalidade</label>
        <select id="modalidadeFilter" disabled>
          <option value="">Todas</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="tipoFilter">Tipo</label>
        <select id="tipoFilter" disabled>
          <option value="">Todos</option>
        </select>
      </div>

      <div class="valor-group">
        <span>Valor (R$)</span>
        <input type="number" id="minValor" placeholder="mín" disabled />
        <input type="number" id="maxValor" placeholder="máx" disabled />
      </div>

      <button id="btnFiltrar" disabled>Filtrar imóveis</button>
    </div>
  </header>

  <section id="sheet">
    <div id="sheet-handle"></div>
    <h2>Comece carregando o CSV</h2>
    <p>No site da Caixa, selecione o estado, baixe o CSV e depois escolha o arquivo aqui em cima.</p>
    <p style="margin-top:6px;">Depois use os filtros (cidade, modalidade, tipo e valor) e clique em <strong>Filtrar imóveis</strong> para ver os pins no mapa.</p>
  </section>

  <!-- Leaflet + PapaParse -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const BACKEND_URL = "https://arrematecerto.onrender.com";

    const fileInput   = document.getElementById("fileInput");
    const statusEl    = document.getElementById("status");
    const sheetEl     = document.getElementById("sheet");
    const cidadeSel   = document.getElementById("cidadeFilter");
    const modSel      = document.getElementById("modalidadeFilter");
    const tipoSel     = document.getElementById("tipoFilter");
    const minValorInp = document.getElementById("minValor");
    const maxValorInp = document.getElementById("maxValor");
    const btnFiltrar  = document.getElementById("btnFiltrar");

    // Mapa (centro SP só como default)
    const map = L.map("map").setView([-22.5, -48], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let imoveis = [];        // todos do CSV
    let imoveisFiltrados = []; // resultado atual de filtro
    let imovelSelecionado = null;

    function parseNumeroBr(valorStr) {
      if (!valorStr) return 0;
      let s = String(valorStr).trim();
      s = s.replace(/[R$\s]/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return Number.isNaN(n) ? 0 : n;
    }

    function normalizarImovel(row, idx) {
      const uf         = (row["UF"] || "").trim();
      const cidade     = (row["Cidade"] || "").trim();
      const bairro     = (row["Bairro"] || "").trim();
      const endereco   = (row["Endereço"] || "").trim();
      const modalidade = (row["Modalidade de venda"] || "").trim();
      const tipo       = ((row["Descrição"] || "").split(",")[0] || "Imóvel").trim();

      const valor      = parseNumeroBr(row["Preço"]);
      const valorAval  = parseNumeroBr(row["Valor de avaliação"]);
      const desconto   = (row["Desconto"] || "").trim();
      const link       = (row["Link de acesso"] || "").trim();

      return {
        id: idx,
        bruto: row,
        uf,
        cidade,
        bairro,
        logradouro: endereco,
        modalidade,
        tipo,
        valor,
        valor_avaliacao: valorAval,
        desconto,
        link,
        area: 0,
        lat: null,
        lng: null
      };
    }

    function preencherSheetInicial() {
      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>Use os filtros e clique em Filtrar</h2>
        <p>Selecione cidade, modalidade, tipo e faixa de valor para focar nos imóveis que fazem sentido para você.</p>
        <p style="margin-top:6px;">Depois clique em um pin para ver os detalhes e rodar a análise de viabilidade com IA.</p>
      `;
    }

    async function geocodeEndereco(imovel) {
      const enderecoFmt = `${imovel.logradouro}, ${imovel.bairro}, ${imovel.cidade}, ${imovel.uf}, Brasil`;

      if (!window._geoCache) window._geoCache = {};
      if (window._geoCache[enderecoFmt]) {
        return window._geoCache[enderecoFmt];
      }

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(enderecoFmt)}&email=arrematecerto@app`;

      try {
        const resp = await fetch(url, {
          headers: {
            "User-Agent": "ArremateCerto/1.0 (pesquisa de imoveis)"
          }
        });
        const data = await resp.json();
        if (Array.isArray(data) && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
            window._geoCache[enderecoFmt] = [lat, lon];
            return [lat, lon];
          }
        }
      } catch (e) {
        console.error("Erro ao geocodificar:", e);
      }
      return [null, null];
    }

    function preencherSheetImovel(i) {
      imovelSelecionado = i;

      const valorTexto =
        i.valor && i.valor > 0
          ? "R$ " + i.valor.toLocaleString("pt-BR")
          : "Não informado";

      const avalTexto =
        i.valor_avaliacao && i.valor_avaliacao > 0
          ? "R$ " + i.valor_avaliacao.toLocaleString("pt-BR")
          : "Não informado";

      sheetEl.innerHTML = `
        <div id="sheet-handle"></div>
        <h2>${i.tipo}</h2>
        <div class="tag-row">
          <span class="tag green">${i.modalidade || "Modalidade não informada"}</span>
        </div>

        <p><strong>Local:</strong> ${i.logradouro || ""}${i.logradouro ? ", " : ""}${i.bairro || ""} – ${i.cidade || ""}/${i.uf || ""}</p>
        <p><strong>Valor:</strong> ${valorTexto}</p>
        <p><strong>Avaliação:</strong> ${avalTexto}</p>
        <p><strong>Desconto informado:</strong> ${i.desconto || "Não informado"}</p>
        ${
          i.link
            ? `<p><a href="${i.link}" target="_blank" rel="noopener" style="font-size:12px;">Ver anúncio no site da Caixa</a></p>`
            : ""
        }

        <button id="btnIA" style="
          margin-top:6px;
          padding:6px 10px;
          border-radius:999px;
          background:#14b8a6;
          color:#022c22;
          border:none;
          cursor:pointer;
          font-size:12px;
        ">Analisar com IA</button>

        <div id="respIA" style="margin-top:6px; font-size:12px;"></div>
      `;

      const btnIA  = document.getElementById("btnIA");
      const respIA = document.getElementById("respIA");

      btnIA.onclick = async () => {
        respIA.textContent = "Analisando viabilidade...";
        try {
          const resp = await fetch(`${BACKEND_URL}/api/imoveis/analise`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(i)
          });
          if (!resp.ok) {
            respIA.textContent = `Erro na análise (HTTP ${resp.status})`;
            return;
          }
          const data = await resp.json();
          respIA.innerHTML = `
            <p><strong>Score:</strong> ${data.score ?? "?"}/100</p>
            <p><strong>Resumo:</strong> ${data.resumo || ""}</p>
          `;
        } catch (e) {
          console.error(e);
          respIA.textContent = "Erro ao chamar IA.";
        }
      };
    }

    async function geocodificarEPlotar(lista) {
      markersLayer.clearLayers();
      const bounds = [];

      const total = lista.length;
      const LIMITE_GEO = 120; // limite de imóveis por filtro
      const limite = Math.min(total, LIMITE_GEO);

      if (!limite) {
        statusEl.textContent = "Nenhum imóvel atende aos filtros.";
        preencherSheetInicial();
        return;
      }

      for (let idx = 0; idx < limite; idx++) {
        const imovel = lista[idx];
        statusEl.textContent = `Geocodificando imóveis do filtro (${idx + 1}/${limite})...`;

        const [lat, lon] = await geocodeEndereco(imovel);
        if (lat != null && lon != null) {
          imovel.lat = lat;
          imovel.lng = lon;

          const marker = L.marker([lat, lon]).addTo(markersLayer);
          bounds.push([lat, lon]);

          marker.on("click", () => preencherSheetImovel(imovel));
        }
      }

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [40, 80] });
        const msgExtra = total > limite
          ? ` (mostrando até ${limite} imóveis no mapa)`
          : "";
        statusEl.textContent = `Filtro aplicado: ${bounds.length} imóveis geolocalizados de ${total}${msgExtra}.`;
      } else {
        map.setView([-22.5, -48], 6);
        statusEl.textContent = "Nenhum imóvel do filtro pôde ser geolocalizado.";
      }

      preencherSheetInicial();
    }

    function aplicarFiltros() {
      if (!imoveis.length) return;

      const cidade   = cidadeSel.value;
      const modalidade = modSel.value;
      const tipo     = tipoSel.value;
      const minVal   = minValorInp.value ? Number(minValorInp.value) : null;
      const maxVal   = maxValorInp.value ? Number(maxValorInp.value) : null;

      imoveisFiltrados = imoveis.filter(i => {
        if (cidade && i.cidade !== cidade) return false;
        if (modalidade && i.modalidade !== modalidade) return false;
        if (tipo && i.tipo !== tipo) return false;
        if (minVal != null && i.valor && i.valor < minVal) return false;
        if (maxVal != null && i.valor && i.valor > maxVal) return false;
        return true;
      });

      statusEl.textContent = `Filtro retornou ${imoveisFiltrados.length} imóveis. Iniciando geocodificação...`;
      geocodificarEPlotar(imoveisFiltrados);
    }

    function popularFiltros() {
      const cidades = Array.from(
        new Set(imoveis.map(i => i.cidade).filter(Boolean))
      ).sort((a,b) => a.localeCompare(b, "pt-BR"));

      const modalidades = Array.from(
        new Set(imoveis.map(i => i.modalidade).filter(Boolean))
      ).sort((a,b) => a.localeCompare(b, "pt-BR"));

      const tipos = Array.from(
        new Set(imoveis.map(i => i.tipo).filter(Boolean))
      ).sort((a,b) => a.localeCompare(b, "pt-BR"));

      cidadeSel.innerHTML = `<option value="">Todas</option>` +
        cidades.map(c => `<option value="${c}">${c}</option>`).join("");

      modSel.innerHTML = `<option value="">Todas</option>` +
        modalidades.map(m => `<option value="${m}">${m}</option>`).join("");

      tipoSel.innerHTML = `<option value="">Todos</option>` +
        tipos.map(t => `<option value="${t}">${t}</option>`).join("");

      const valores = imoveis
        .map(i => i.valor)
        .filter(v => typeof v === "number" && v > 0);

      if (valores.length) {
        const min = Math.min(...valores);
        const max = Math.max(...valores);
        minValorInp.value = Math.floor(min);
        maxValorInp.value = Math.ceil(max);
      } else {
        minValorInp.value = "";
        maxValorInp.value = "";
      }

      cidadeSel.disabled   = false;
      modSel.disabled      = false;
      tipoSel.disabled     = false;
      minValorInp.disabled = false;
      maxValorInp.disabled = false;
      btnFiltrar.disabled  = false;
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusEl.textContent = "Lendo CSV...";

      Papa.parse(file, {
        header: false,
        skipEmptyLines: true,
        delimiter: ";",
        complete: function(results) {
          try {
            const rows = results.data;

            // acha o header pela combinação UF + Cidade
            const headerIndex = rows.findIndex(r => {
              const c1 = (r[1] || "").trim().toUpperCase();
              const c2 = (r[2] || "").trim().toUpperCase();
              return c1 === "UF" && c2 === "CIDADE";
            });

            if (headerIndex === -1) {
              console.error("Cabeçalho não encontrado. Primeiras linhas:", rows.slice(0,5));
              statusEl.textContent = "Erro: cabeçalho do CSV não encontrado.";
              return;
            }

            const headerRow = rows[headerIndex].map(h => (h || "").trim());
            const dataRows = rows
              .slice(headerIndex + 1)
              .filter(r => (r[0] || "").trim() !== "");

            const lista = dataRows.map((r, idx) => {
              const obj = {};
              headerRow.forEach((h, colIdx) => {
                obj[h] = (r[colIdx] || "").trim();
              });
              return normalizarImovel(obj, idx);
            });

            imoveis = lista;
            statusEl.textContent = `CSV carregado (${lista.length} imóveis). Agora selecione os filtros e clique em "Filtrar imóveis".`;
            popularFiltros();
            preencherSheetInicial();
          } catch (e) {
            console.error("Erro no processamento do CSV:", e);
            statusEl.textContent = "Erro ao processar o CSV (veja o console do navegador).";
          }
        },
        error: function(err) {
          console.error("Erro PapaParse:", err);
          statusEl.textContent = "Erro ao ler o arquivo CSV.";
        }
      });
    });

    btnFiltrar.addEventListener("click", aplicarFiltros);

    preencherSheetInicial();
  </script>
</body>
</html>
